bk72xx:
  board: cbu
  framework:
    version: latest

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Power Meter Fallback Hotspot"
    password: !secret wifi_fallback_password

esphome:
  name: hackem-powermeter
  friendly_name: "Hackem Power Meter"

api:
  encryption:
    key: !secret doorlock_apikey

ota:
  password: !secret ota_pass

status_led:
  pin:
    number: P15
    inverted: true

uart:
  baud_rate: 4800
  rx_pin: RX1
  tx_pin: TX1
  stop_bits: 1
  id: uart_bus


logger:
  baud_rate: 0

button:
  - platform: restart
    name: Restart
  - platform: template
    name: "Cut off the power"
    on_press:
      - switch.turn_off: switch_relay

sensor:
  - platform: bl0942
    uart_id: uart_bus
    voltage:
      name: 'BL0942 Voltage'
    current:
      name: 'BL0942 Current'
    power:
      name: 'BL0942 Power'
      filters:
        multiply: -1
    energy:
      name: 'BL0942 Energy'
    frequency:
      name: "BL0942 Frequency"
      accuracy_decimals: 2
    update_interval: 5s

binary_sensor:
  - platform: gpio
    pin:
      number: P17
      inverted: true
      mode:
        input: true
        pullup: true
    name: Button
    filters:
      - delayed_on: 10ms
    internal: true
    on_click:
    - min_length: 1000ms
      max_length: 5000ms
      then:
        - switch.toggle: switch_relay
    - min_length: 50ms
      max_length: 1000ms
      then:
        - homeassistant.event:
            event: esphome.button_pressed
            data:
                message: Power Meter Button Clicked

output:
  - platform: gpio
    pin:
      number: P24
    id: 'relay_on'
  - platform: gpio
    pin:
      number: P26
    id: 'relay_off'
  - platform: gpio
    pin:
      number: P9
      inverted: true
    id: 'led'
  - platform: template
    id: bridge_relay
    type: binary
    write_action:
      - if:
          condition:
            lambda: return (state == 1);
          then:
            - output.turn_on: led
            - output.turn_off: relay_off
            - output.turn_on: relay_on
            - delay: 60ms
            - output.turn_off: relay_on
          else:
            - output.turn_off: led
            - output.turn_off: relay_on
            - output.turn_on: relay_off
            - delay: 60ms
            - output.turn_off: relay_off

switch:
  - platform: output
    id: switch_relay
    name: "Switch"
    output: 'bridge_relay'
    restore_mode: RESTORE_DEFAULT_ON
    disabled_by_default: true